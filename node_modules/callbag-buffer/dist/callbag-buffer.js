'use strict';

function buffer(separator) {
  return function (source) {
    return function (start, sink) {
      if (start !== 0) return;
      var sourceTalkback;
      var separatorTalkback;
      var buffer = [];
      source(0, function (type, data) {
        if (type === 0) {
          sourceTalkback = data;
          sink(0, function (type, data) {
            if (type === 2) {
              sourceTalkback(2);
              separatorTalkback(2);
              return;
            }

            sourceTalkback(type, data);
          });
          return;
        }

        if (type === 1) {
          buffer.push(data);
          return;
        }

        if (type === 2) {
          separatorTalkback(2);
        }

        sink(type, data);
      });
      separator(0, function (type, data) {
        if (type === 0) {
          separatorTalkback = data;
          return;
        }

        sink(1, buffer.splice(0));
      });
    };
  };
}

module.exports = buffer;
