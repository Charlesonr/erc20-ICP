import { createPipe } from "./createPipe.js";
export const batchCount_ = (self, batchSize) => (_, sink) => {
    let buffer = [];
    createPipe(self, sink, {
        onStart(s) {
            s.pull();
        },
        onRequest(s) {
            s.pull();
        },
        onData(s, data) {
            buffer.push(data);
            if (buffer.length >= batchSize) {
                sink(1, buffer);
                buffer = [];
            }
            else {
                s.pull();
            }
        },
        onEnd(err) {
            if (buffer.length > 0) {
                sink(1, buffer);
                buffer = [];
            }
            sink(2, err);
        },
        onAbort() {
            buffer = [];
        },
    });
};
export const batchCount = (batchSize) => (self) => batchCount_(self, batchSize);
