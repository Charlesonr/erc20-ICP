import * as tsplus_module_1 from "@effect/io/Ref";
import * as tsplus_module_2 from "@fp-ts/data/Option";
import * as tsplus_module_3 from "@effect/io/Effect";
import * as tsplus_module_4 from "dfx/common-gateway";
import * as tsplus_module_5 from "@effect/io/Schedule";
import * as tsplus_module_6 from "callbag-effect-ts/Source/fromSchedule";
import * as tsplus_module_7 from "dfx/common";
import * as tsplus_module_8 from "callbag-effect-ts/Source/tap";
import * as tsplus_module_9 from "callbag-effect-ts/Source/switchMap";
import * as tsplus_module_10 from "callbag-effect-ts/Source/mapEffect";
import * as tsplus_module_11 from "callbag-effect-ts/Source/drain";
import * as tsplus_module_12 from "callbag-effect-ts/Source/merge";
import * as tsplus_module_13 from "callbag-effect-ts/Source/unwrap";
import { millis } from "@fp-ts/data/Duration";
import * as SendEvents from "./sendEvents.js";
import * as Utils from "./utils.js";
const send = (ref, seqRef) => tsplus_module_3.tap(() => tsplus_module_1.set(false)(ref))(tsplus_module_3.map((a) => SendEvents.heartbeat(tsplus_module_2.getOrNull(a)))(tsplus_module_1.get(seqRef)));
const maybeSend = (ref, seqRef) => tsplus_module_3.flatMap((acked) => acked ? send(ref, seqRef) : tsplus_module_3.succeed(tsplus_module_4.WS.Reconnect))(tsplus_module_1.get(ref));
export const fromRaw = (source, seqRef) => tsplus_module_13.unwrap(tsplus_module_3.map((ackedRef) => {
    const heartbeats = tsplus_module_10.mapEffect(() => maybeSend(ackedRef, seqRef))(tsplus_module_9.switchMap((p) => tsplus_module_6.fromSchedule(tsplus_module_5.andThen(tsplus_module_5.spaced(millis(p.d.heartbeat_interval)))(tsplus_module_5.duration(millis(p.d.heartbeat_interval * Math.random())))))(tsplus_module_8.tap(() => tsplus_module_1.set(true)(ackedRef))(Utils.opCode(source)(tsplus_module_7.Discord.GatewayOpcode.HELLO))));
    const acks = tsplus_module_11.drain(tsplus_module_8.tap(() => tsplus_module_1.set(true)(ackedRef))(Utils.opCode(source)(tsplus_module_7.Discord.GatewayOpcode.HEARTBEAT_ACK)));
    return tsplus_module_12.merge(acks)(heartbeats);
})(tsplus_module_1.make(true)));
//# sourceMappingURL=heartbeats.js.map